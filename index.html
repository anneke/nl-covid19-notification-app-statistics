<html>
  <head>
    <title>CoronaMelder stats</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <style>
      .grafiek {
        width: 600px;
        height: 300px;
        padding-bottom: 50px;
      }
    </style>
  </head>

    <h1>Statistieken CoronaMelder.nl</h1>

    <article>
      <h2>Mensen die CoronaMelder gedownload hebben</h2>

      <strong id="aantalDownloads"></strong>

      <figure class="grafiek">
        <div id="grafiekDownloads"></div>
        <figcaption>De grafiek laat zien hoeveel mensen CoronaMelder
          hebben gedownload.</figcaption>
      </figure>

      <p><strong id="aantalDownloadsPercentageBevolking"></strong> van de Nederlandse bevolking heeft
        CoronaMelder gedownload.</p>
    </article>

    <article>
      <h2>Mensen die anderen waarschuwden via CoronaMelder</h2> 

      <figure class="grafiek">
        <div id="aantalWaarschuwingen"></div>
        <figcaption>De grafiek laat zien hoeveel mensen gewaarschuwd zijn via CoronaMelder.</figcaption>
      </figure>
      <p>
        Als je positief getest bent op corona, dan kun je dit
        vrijwillig aangeven in de app, samen met een
        medewerker van de GGD.<br />
        De grafiek laat zien hoeveel mensen dit hebben gedaan
        na landelijke introductie van CoronaMelder op 10
        oktober
      </p>
    </article>

    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://d3js.org/d3-time.v2.min.js"></script>
    <script src="https://d3js.org/d3-time-format.v3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script>


    <script>
      
    </script>

    <script>
      d3.csv("statistics/appstore_statistics.csv", function(data) {
        return {
          downloads_date: data["Date (yyyy-mm-dd)"],
          downloads_iOS_daily :  +data["Downloads App Store (iOS) (daily)"],
          downloads_PlayStore_daily : +data["Downloads Play Store (Android) (daily)"],
          downloads_Huawei_daily : +data["Downloads Huawei App Gallery (Android) (daily)"],
          downloads_Total_daily : +data["Total downloads (daily)"],
          Total_cumulative : +data["Total downloads (cumulative)"],
        };
      }).then(function(data) {

        const justDates = data.map((loop) => loop.downloads_date);
        newArray = convertToWeekNumbers(justDates);

        // get total number of downloads
        const aantalDownloads = document.getElementById("aantalDownloads");
        aantalDownloads.innerHTML = data[data.length - 1].Total_cumulative.toLocaleString('nl-NL');

        // get number of downloads and use it to calculate the percentage of the total number of Dutchies
        const aantalDownloadsPercentageBevolking = document.getElementById("aantalDownloadsPercentageBevolking");
        const bevolkingNederland = 17472667;
        const calcPercentage = (data[data.length - 1].Total_cumulative / bevolkingNederland) * 100;
        aantalDownloadsPercentageBevolking.innerHTML = calcPercentage.toFixed(2) + '%';

        function barChart(data) {
          var w= 1200;
          var h= (data[data.length - 1].Total_cumulative / 6500);

          var svg= d3.select('#grafiekDownloads')
              .append('svg')
              .attr('viewBox', '0 0 ' + w + ' ' + h);

          var barwidth = w / data.length;

          svg.selectAll('rect.colorBar')
              .data(data)
              .enter()
              .append('rect')
              .attr('width', function(d,i){
                  return (w / (data.length + 2));
              })
              .attr('height', function(d,i){
                  const test = (data[i].Total_cumulative / 6500);
                  return test;
              })
              .attr('x', function(d,i){
                  return i * (barwidth + 2);
              })
              .attr('y', function(d,i){
                  return h - (data[i].Total_cumulative / 6500);
              })
              .attr('fill', 'blue')
              .attr('data-date', function(d,i){
                return data[i].downloads_date;
              });
          }

          barChart(data);
      });

      d3.csv("statistics/ggd_positive_test_authorisations.csv", function(data) {
        return {
          positive_tests_date: data["Date (yyyy-mm-dd)"],
          positive_tests_thisday: +data["Reported positive tests through app authorised by GGD (daily)"],
          Total_cumulative : +data["Reported positive test through app authorised by GGD (cumulative)"],
        };
      }).then(function(data) {

        const justDates = data.map((loop) => loop.positive_tests_date);
        // console.log(justDates);

        newArrayTwo = convertToWeekNumbers(justDates);

        function barChartGGD(data) {
          var w= 1200;
          var h= (data[data.length - 1].Total_cumulative / 100);

          var svg= d3.select('#aantalWaarschuwingen')
              .append('svg')
              .attr('viewBox', '0 0 ' + w + ' ' + h);

          var barwidth = w / data.length;

          svg.selectAll('rect.colorBar')
              .data(data)
              .enter()
              .append('rect')
              .attr('width', function(d,i){
                  return (w / (data.length + 2));
              })
              .attr('height', function(d,i){
                  const test = (data[i].Total_cumulative / 100);
                  return test;
              })
              .attr('x', function(d,i){
                  return i * (barwidth + 2);
              })
              .attr('y', function(d,i){
                  return h - (data[i].Total_cumulative / 100);
              })
              .attr('fill', 'blue')
              .attr('data-date', function(d,i){
                return data[i].positive_tests_date;
              });
        }

          barChartGGD(data);
      });

      function convertToWeekNumbers(data) {
        /* Helper to get the ISO week number of a date
        ** @param {Date} date to get week of
        ** @returns {Array} [year, weekNumber]
        */
        function getWeekNumber(d) {
          d = new Date(+d);
          d.setHours(0,0,0,0);
          d.setDate(d.getDate() + 4 - (d.getDay()||7));
          var yearStart = new Date(d.getFullYear(),0,1);
          var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
          return [weekNo];
        }

        /* Parse ISO 8601 format date string to local date
        ** @param {string} s - string to parse like 2016-12-15
        ** @returns {Date}
        */
        function parseISOLocal(s) {
          var b = s.split(/\D/);
          return new Date(b[0],b[1]-1,b[2]);
        }

        var arr = data.map(function(s){
          var week = getWeekNumber(parseISOLocal(s));
          return week[0] + ('0' + week[1]);
        }).sort();

        console.log('arr' + arr);

        // Group in arrays by week in an object
        var groupedObj = arr.reduce(function (result, value) {
          var b = value;
          if (!result[b[0]]) result[b[0]] = [];
          result[b[0]].push(b[1]);
          return result;
        },{});

        console.log('groupedObj' + groupedObj);

        // Grab arrays in order of week number. Sort keys to maintain order
        var groupedArray = Object.keys(groupedObj).sort().map(key=>groupedObj[key]);


        console.log('groupedArray' + groupedArray);

        // Final set of grouped dates
        console.log(groupedArray.join('\n\n'));
      }
    </script>
</html>

